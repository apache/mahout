# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements. See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License. You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

sudo: required

dist: trusty

cache:
  directories:
  - $HOME/.m2

install: true

language: java

branches:
  only:
   - master

env:
  global:
    - JAVA_OPTS=-Xmx3g
    # exclude these modules
    - EXCLUDE_MODULES='!flink'
    - TEST_MODULES="hdfs,math,math-scala,spark"
    - STANDARD_BUILD_OPTS="-Dmaven.javadoc.skip=true -B -V"
    - PROFILES="-Phadoop2 -Ptravis"

# The file assumes a certain build order for the maven / nightly build deployments.
matrix:
  include:
    # Build Spark 1.6.3 , Scala 2.10
    - jdk: "oraclejdk7"
      env: PROFILES="${PROFILES}"

    # Build Spark 2.0.2 , Scala 2.11 - replace -D... with profiles when available
    - jdk: "oraclejdk7"
      env: PROFILES="${PROFILES} -Dspark.version=2.0.2 -Dscala.version=2.11.8 -Dscala.compat.version=2.11"

    # Build Spark 2.1.0 , Scala 2.11 - replace -D... with profiles when available
    - jdk: "oraclejdk7"
      env: PROFILES="${PROFILES} -Dspark.version=2.1.0 -Dscala.version=2.11.8 -Dscala.compat.version=2.11"

    # Build Spark 1.6.3 , Scala 2.10, ViennaCL
    - jdk: "oraclejdk7"
      env: PROFILES="${PROFILES} -Pviennacl"

#    # Build Spark 2.0.2 , Scala 2.11, ViennaCL - replace -D... with profiles when available
#    - jdk: "oraclejdk7"
#      env: PROFILES="${PROFILES} -Dspark.version=2.0.2 -Dscala.version=2.11.8 -Dscala.compat.version=2.11 -Pviennacl"
#
#    # Build Spark 2.1.0 , Scala 2.11, ViennaCL - replace -D... with profiles when available
#    - jdk: "oraclejdk7"
#      env: PROFILES="${PROFILES} -Dspark.version=2.1.0 -Dscala.version=2.11.8 -Dscala.compat.version=2.11 -Pviennacl"

    # Build Spark 1.6.3 , Scala 2.10, ViennaCL-OMP
    - jdk: "oraclejdk7"
      env: PROFILES="${PROFILES} -Pviennacl-omp" TEST_MODULES="${TEST_MODULES},viennacl-omp"

#    # Build Spark 2.0.2 , Scala 2.11, ViennaCL-OMP - replace -D... with profiles when available
#    - jdk: "oraclejdk7"
#      env: PROFILES="${PROFILES} -Dspark.version=2.0.2 -Dscala.version=2.11.8 -Dscala.compat.version=2.11 -Pviennacl-omp" TEST_MODULES="${TEST_MODULES},viennacl-omp"
#
#    # Build Spark 2.1.0 , Scala 2.11, ViennaCL-OMP - replace -D... with profiles when available
#    - jdk: "oraclejdk7"
#      env: PROFILES="${PROFILES} -Dspark.version=2.1.0 -Dscala.version=2.11.8 -Dscala.compat.version=2.11 -Pviennacl-omp" TEST_MODULES="${TEST_MODULES},viennacl-omp"

git:
  depth: 10

#notifications:
#  slack: mahout:7vlbihiCBKuhEZK2610jkeeT

before_install:
  - wget https://archive.apache.org/dist/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.zip
  - unzip -qq apache-maven-3.3.9-bin.zip
  - export M2_HOME=$PWD/apache-maven-3.3.9
  - export PATH=$M2_HOME/bin:$PATH
  - export MAHOUT_HOME=$PWD
  - sudo apt-get -qq update
  - sudo apt-get install ocl-icd-libopencl1
  - wget https://github.com/viennacl/viennacl-dev/archive/release-1.7.1.zip
  - unzip -qq release-1.7.1.zip
  - sudo cp -r viennacl-dev-release-1.7.1/viennacl /usr/include/viennacl
  - sudo cp -r viennacl-dev-release-1.7.1/CL /usr/include/CL

script:
  - mvn clean -pl $EXCLUDE_MODULES package $PROFILES $STANDARD_BUILD_OPTS -DskipTests
  - mvn test -pl $TEST_MODULES $PROFILES
