"use strict";(globalThis.webpackChunkmahout_website=globalThis.webpackChunkmahout_website||[]).push([[4800],{5871(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"qdp/observability","title":"Observability","description":"Overview","source":"@site/versioned_docs/version-0.5/qdp/observability.md","sourceDirName":"qdp","slug":"/qdp/observability","permalink":"/docs/qdp/observability","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/mahout/tree/main/docs/versioned_docs/version-0.5/qdp/observability.md","tags":[],"version":"0.5","frontMatter":{"title":"Observability"},"sidebar":"docsSidebar","previous":{"title":"Readers","permalink":"/docs/qdp/readers"},"next":{"title":"Testing","permalink":"/docs/qdp/testing"}}');var r=i(4848),l=i(8453);const o={title:"Observability"},t="NVTX Profiling Guide",c={},d=[{value:"Overview",id:"overview",level:2},{value:"Build with NVTX",id:"build-with-nvtx",level:2},{value:"Run Example",id:"run-example",level:2},{value:"Profile with Nsight Systems",id:"profile-with-nsight-systems",level:2},{value:"Viewing Results",id:"viewing-results",level:2},{value:"GUI View (Nsight Systems)",id:"gui-view-nsight-systems",level:3},{value:"Command Line Statistics",id:"command-line-statistics",level:3},{value:"NVTX Markers",id:"nvtx-markers",level:2},{value:"Using Profiling Macros",id:"using-profiling-macros",level:2},{value:"Example Location",id:"example-location",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"nvtx-profiling-guide",children:"NVTX Profiling Guide"})}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["NVTX (NVIDIA Tools Extension) provides performance markers visible in Nsight Systems. This project uses zero-cost macros that compile to no-ops when the ",(0,r.jsx)(n.code,{children:"observability"})," feature is disabled."]}),"\n",(0,r.jsx)(n.h2,{id:"build-with-nvtx",children:"Build with NVTX"}),"\n",(0,r.jsx)(n.p,{children:"Default builds exclude NVTX for zero overhead. Enable profiling with:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd mahout/qdp\ncargo build -p qdp-core --example nvtx_profile --features observability --release\n"})}),"\n",(0,r.jsx)(n.h2,{id:"run-example",children:"Run Example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./target/release/examples/nvtx_profile\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Expected output:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"=== NVTX Profiling Example ===\n\n\u2713 Engine initialized\n\u2713 Created test data: 1024 elements\n\nStarting encoding (NVTX markers will appear in Nsight Systems)...\nExpected NVTX markers:\n  - Mahout::Encode\n  - CPU::L2Norm\n  - GPU::Alloc\n  - GPU::H2DCopy\n  - GPU::KernelLaunch\n  - GPU::Synchronize\n  - DLPack::Wrap\n\n\u2713 Encoding succeeded\n\u2713 DLPack pointer: 0x558114be6250\n\u2713 Memory freed\n\n=== Test Complete ===\n"})}),"\n",(0,r.jsx)(n.h2,{id:"profile-with-nsight-systems",children:"Profile with Nsight Systems"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nsys profile --trace=cuda,nvtx -o report ./target/release/examples/nvtx_profile\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This generates ",(0,r.jsx)(n.code,{children:"report.nsys-rep"})," and ",(0,r.jsx)(n.code,{children:"report.sqlite"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"viewing-results",children:"Viewing Results"}),"\n",(0,r.jsx)(n.h3,{id:"gui-view-nsight-systems",children:"GUI View (Nsight Systems)"}),"\n",(0,r.jsx)(n.p,{children:"Open the report in Nsight Systems GUI:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nsys-ui report.nsys-rep\n"})}),"\n",(0,r.jsx)(n.p,{children:"In the GUI timeline view, you will see:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Colored blocks for each NVTX marker"}),"\n",(0,r.jsxs)(n.li,{children:["CPU timeline showing ",(0,r.jsx)(n.code,{children:"CPU::L2Norm"})]}),"\n",(0,r.jsxs)(n.li,{children:["GPU timeline showing ",(0,r.jsx)(n.code,{children:"GPU::Alloc"}),", ",(0,r.jsx)(n.code,{children:"GPU::H2DCopy"}),", ",(0,r.jsx)(n.code,{children:"GPU::Kernel"})]}),"\n",(0,r.jsxs)(n.li,{children:["Overall workflow covered by ",(0,r.jsx)(n.code,{children:"Mahout::Encode"})]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"command-line-statistics",children:"Command Line Statistics"}),"\n",(0,r.jsx)(n.p,{children:"View summary statistics:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"nsys stats report.nsys-rep\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Example NVTX Range Summary output:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Time (%)  Total Time (ns)  Instances    Avg (ns)      Med (ns)     Min (ns)    Max (ns)   StdDev (ns)   Style        Range\n--------  ---------------  ---------  ------------  ------------  ----------  ----------  -----------  --------  --------------\n   50.0       11,207,505          1  11,207,505.0  11,207,505.0  11,207,505  11,207,505          0.0  StartEnd  Mahout::Encode\n   48.0       10,759,758          1  10,759,758.0  10,759,758.0  10,759,758  10,759,758          0.0  StartEnd  GPU::Alloc\n    1.8          413,753          1     413,753.0     413,753.0     413,753     413,753          0.0  StartEnd  CPU::L2Norm\n    0.1           15,873          1      15,873.0      15,873.0      15,873      15,873          0.0  StartEnd  GPU::H2DCopy\n    0.0              317          1         317.0         317.0         317         317          0.0  StartEnd  GPU::KernelLaunch\n"})}),"\n",(0,r.jsx)(n.p,{children:"The output shows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Time percentage for each operation"}),"\n",(0,r.jsx)(n.li,{children:"Total time in nanoseconds"}),"\n",(0,r.jsx)(n.li,{children:"Number of instances"}),"\n",(0,r.jsx)(n.li,{children:"Average, median, min, max execution times"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"CUDA API Summary"})," shows detailed CUDA call statistics:"]}),"\n",(0,r.jsx)(n.p,{children:"Time (%)  Total Time (ns)  Num Calls   Avg (ns)     Med (ns)    Min (ns)   Max (ns)   StdDev (ns)          Name"}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:" 99.2       11,760,277          2  5,880,138.5  5,880,138.5     2,913  11,757,364  8,311,652.0  cuMemAllocAsync\n  0.4           45,979          2     22,989.5     22,989.5     7,938      38,041     21,286.0  cuMemcpyHtoDAsync_v2\n  0.1           14,722          1     14,722.0     14,722.0    14,722      14,722          0.0  cuEventCreate\n  0.1           13,100          3      4,366.7      3,512.0       861       8,727      4,002.0  cuStreamSynchronize\n  0.1            9,468         11        860.7        250.0       114       4,671      1,453.3  cuCtxSetCurrent\n  0.1            6,479          1      6,479.0      6,479.0     6,479       6,479          0.0  cuEventDestroy_v2\n  0.0            4,599          2      2,299.5      2,299.5     1,773       2,826        744.6  cuMemFreeAsync\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Memory allocation (",(0,r.jsx)(n.code,{children:"cuMemAllocAsync"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Memory copies (",(0,r.jsx)(n.code,{children:"cuMemcpyHtoDAsync_v2"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Stream synchronization (",(0,r.jsx)(n.code,{children:"cuStreamSynchronize"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"nvtx-markers",children:"NVTX Markers"}),"\n",(0,r.jsx)(n.p,{children:"The following markers are tracked:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Mahout::Encode"})," - Complete encoding workflow"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CPU::L2Norm"})," - L2 normalization on CPU"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GPU::Alloc"})," - GPU memory allocation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GPU::H2DCopy"})," - Host-to-device memory copy"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GPU::KernelLaunch"})," - CPU-side kernel launch"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"GPU::Synchronize"})," - CPU waiting for GPU completion"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DLPack::Wrap"})," - Conversion to DLPack pointer"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"using-profiling-macros",children:"Using Profiling Macros"}),"\n",(0,r.jsxs)(n.p,{children:["The project provides zero-cost macros in ",(0,r.jsx)(n.code,{children:"qdp-core/src/profiling.rs"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",children:'// Profile a scope (automatically pops on exit)\ncrate::profile_scope!("MyOperation");\n\n// Mark a point in time\ncrate::profile_mark!("Checkpoint");\n'})}),"\n",(0,r.jsxs)(n.p,{children:["When ",(0,r.jsx)(n.code,{children:"observability"})," feature is disabled, these macros compile to no-ops with zero runtime cost."]}),"\n",(0,r.jsx)(n.h2,{id:"example-location",children:"Example Location"}),"\n",(0,r.jsxs)(n.p,{children:["Source code: ",(0,r.jsx)(n.code,{children:"qdp-core/examples/nvtx_profile.rs"})]}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"NVTX markers not appearing:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensure ",(0,r.jsx)(n.code,{children:"--features observability"})," is used during build"]}),"\n",(0,r.jsx)(n.li,{children:"Verify CUDA device is available"}),"\n",(0,r.jsx)(n.li,{children:"Check that encoding actually executes"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"nsys warnings:"}),"\nWarnings about CPU sampling are normal and can be ignored. They do not affect NVTX marker recording."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453(e,n,i){i.d(n,{R:()=>o,x:()=>t});var s=i(6540);const r={},l=s.createContext(r);function o(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);