<!DOCTYPE html>
<html lang=" en ">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>
    Spark Naive Bayes
    
  </title>

  <meta name="description" content="Distributed Linear Algebra">

  <link rel="stylesheet" href="/assets/css/main.css">

  <!-- Font Awesome -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Maven+Pro:400,500" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,700,700i" rel="stylesheet">

  <link rel="canonical" href="http://mahout.apache.org//users/algorithms/spark-naive-bayes.html">
  <link rel="alternate" type="application/rss+xml" title="Apache Mahout" href="/%20/feed.xml">


</head>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-98314020-1', 'auto');
  ga('send', 'pageview');
</script>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-light navbar-mahout">

    <div class="container">

        <a class="navbar-brand" href="/">
          <img src="/assets/mahout-logo-blue.svg" alt="">
        </a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">

            <ul class="navbar-nav ml-auto">

                <!-- Download -->
                <li class="nav-item">
                    <a class="nav-link" href="/general/downloads">Download</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/docs/latest/index.html">Overview</a>
                </li>

                <!-- Algorithms (Samsara / MR) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Algorithms</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item"  href="/docs/latest/algorithms/linear-algebra">Distributed Linear Algebra</a>
                        <a class="dropdown-item"  href="/docs/latest/algorithms/preprocessors">Preprocessors</a>
                        <a class="dropdown-item"  href="/docs/latest/algorithms/regression">Regression</a>
                        <a class="dropdown-item"  href="/docs/latest/algorithms/clustering">Clustering</a>
                        <a class="dropdown-item"  href="/docs/latest/algorithms/recommenders">Recommenders</a>
                        <div class="dropdown-divider"></div>
                        <h6 class="dropdown-header">Deprecated</h6>
                        <a class="dropdown-item"  href="/docs/latest/algorithms/map-reduce">MapReduce <i>(deprecated)</i></a>
                    </div>
                    <!--<a class="dropdown-item"  href="/docs/latest/algorithms/recommenders/recommender-overview.html">Reccomender Overview</a></li> Do we still need? seems like short version of next post-->
                    <!--
                    <a class="dropdown-item"  href="/docs/latest/algorithms/recommenders/intro-cooccurrence-spark.html">Intro to Coocurrence With Spark</a></li>
                    <li role="separator" class="divider"></li>
                    <li><span>&nbsp;&nbsp;<a href="/docs/latest/algorithms/map-reduce"><b>MapReduce</b> (deprecated)</a><span></li>
                 -->
                </li>


                <!-- Developers -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Developers</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="/developers/developer-resources.html">Developer Resources</a>
                        <a class="dropdown-item" href="/developers/buildingmahout">Building Mahout from Source</a>
                        <a class="dropdown-item" href="/developers/issue-tracker">Issues Tracking (JIRA)</a>
                        <!-- <a class="dropdown-item" href="/developers/patch-check-list/">Patch Check List</a> going to github template -->
                        <!-- <a class="dropdown-item" href="/developers/reference/">References</a> a lot of overlap with books, talks, etc. page -->
                        <a class="dropdown-item" href="/developers/release-notes/">Release Notes</a>
                        <!-- <a class="dropdown-item" href="/developers/thirdparty-dependencies/">Third Party Dependencies</a> is our site the reasonable place for this? -->
                        <!-- <a class="dropdown-item" href="/developers/version-control/">Version Control</a> -->
                        <div class="dropdown-divider"></div>
                        <h6 class="dropdown-header">How To's</h6>
                        <a class="dropdown-item" href="/developers/how-to-contribute">How to Contribute</a>
                        <a class="dropdown-item" href="/developers/githubPRs">Github PRs</a>
                        <a class="dropdown-item" href="/developers/how-to-become-a-committer">How to Become a Committer</a>
                        <a class="dropdown-item" href="/developers/how-to-release">How to Release</a>
                        <a class="dropdown-item" href="/developers/how-to-update-the-website">How to Update the Website</a>
                    </div>
                </li>

                <!-- Docs -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Docs</a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <h6 class="dropdown-header">Release</h6>
                        <a class="dropdown-item" href="/docs/0.13.0">0.13.0</a>
                        <div class="dropdown-divider"></div>
                        <h6 class="dropdown-header">Latest Snapshot (Development)</h6>
                        <a class="dropdown-item" href="/docs/latest">0.13.1-SNAPSHOT</a>
                    </div>
                </li>

                <!-- Community -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community</a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <!--<a class="dropdown-item" href="/community/history/">History of the Apache Mahout Project</a>-->
                        <!--<a class="dropdown-item" href="/community/blogs/">Blog Posts About Mahout</a>-->
                        <!--<a class="dropdown-item" href="/community/recent-upcoming-talks/">Recent and Upcoming Talks</a>-->
                        <!-- <a class="dropdown-item" href="/community/books-tutorials-and-talks/">Books Tutorials and Talks</a> -->
                        <!-- <a class="dropdown-item" href="/community/faq/">FAQ</a> needs a lot of updating -->
                        <a class="dropdown-item" href="/developers/gsoc">GSoC</a>
                        <!-- Is OK- updated Map/Reduce verbage to reflect Samsara -->
                        <!-- <a class="dropdown-item" href="/community/mahout-benchmarks/">Mahout Benchmarks</a> These are old, Keep them? -->
                        <!-- <a class="dropdown-item" href="/community/mahout-wiki/">Mahout Wiki</a> at very least needs links cleanedup - do we still want this even?-->
                        <a class="dropdown-item" href="/general/mailing-lists">Mailing Lists</a>
                        <!-- Clean and pretty -->
                        <!-- <a class="dropdown-item" href="/community/powered-by-mahout/">Powered By Mahout</a> needs update -->
                        <a class="dropdown-item" href="/general/privacy-policy">Privacy Policy</a>
                        <!-- <a class="dropdown-item" href="/community/professional-support/">Professional Support</a> update if we even want to keep -->
                        <a class="dropdown-item" href="/general/who-we-are">Who We Are</a>
                        <!-- nikolai needs to add himself -->
                    </div>
                </li>

                <!-- GitHub -->
                <li class="nav-item">
                    <a class="nav-link" href="http://github.com/apache/mahout"><i class="fa fa-github"></i></a>
                </li>

            </ul>

            <!-- <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
        </form> -->

        </div>

    </div>

</nav>


  <h1 id="spark-naive-bayes">Spark Naive Bayes</h1>

<h2 id="intro">Intro</h2>

<p>Mahout currently has two flavors of Naive Bayes.  The first is standard Multinomial Naive Bayes. The second is an implementation of Transformed Weight-normalized Complement Naive Bayes as introduced by Rennie et al. <a href="http://people.csail.mit.edu/jrennie/papers/icml03-nb.pdf">[1]</a>. We refer to the former as Bayes and the latter as CBayes.</p>

<p>Where Bayes has long been a standard in text classification, CBayes is an extension of Bayes that performs particularly well on datasets with skewed classes and has been shown to be competitive with algorithms of higher complexity such as Support Vector Machines.</p>

<h2 id="implementations">Implementations</h2>
<p>The mahout <code class="highlighter-rouge">math-scala</code> library has an implemetation of both Bayes and CBayes which is further optimized in the <code class="highlighter-rouge">spark</code> module. Currently the Spark optimized version provides CLI drivers for training and testing. Mahout Spark-Naive-Bayes models can also be trained, tested and saved to the filesystem from the Mahout Spark Shell.</p>

<h2 id="preprocessing-and-algorithm">Preprocessing and Algorithm</h2>

<p>As described in <a href="http://people.csail.mit.edu/jrennie/papers/icml03-nb.pdf">[1]</a> Mahout Naive Bayes is broken down into the following steps (assignments are over all possible index values):</p>

<ul>
  <li>Let <code class="highlighter-rouge">\(\vec{d}=(\vec{d_1},...,\vec{d_n})\)</code> be a set of documents; <code class="highlighter-rouge">\(d_{ij}\)</code> is the count of word <code class="highlighter-rouge">\(i\)</code> in document <code class="highlighter-rouge">\(j\)</code>.</li>
  <li>Let <code class="highlighter-rouge">\(\vec{y}=(y_1,...,y_n)\)</code> be their labels.</li>
  <li>Let <code class="highlighter-rouge">\(\alpha_i\)</code> be a smoothing parameter for all words in the vocabulary; let <code class="highlighter-rouge">\(\alpha=\sum_i{\alpha_i}\)</code>.</li>
  <li><strong>Preprocessing</strong>(via seq2Sparse) TF-IDF transformation and L2 length normalization of <code class="highlighter-rouge">\(\vec{d}\)</code>
    <ol>
      <li><code class="highlighter-rouge">\(d_{ij} = \sqrt{d_{ij}}\)</code></li>
      <li><code class="highlighter-rouge">\(d_{ij} = d_{ij}\left(\log{\frac{\sum_k1}{\sum_k\delta_{ik}+1}}+1\right)\)</code></li>
      <li><code class="highlighter-rouge">\(d_{ij} =\frac{d_{ij}}{\sqrt{\sum_k{d_{kj}^2}}}\)</code></li>
    </ol>
  </li>
  <li><strong>Training: Bayes</strong><code class="highlighter-rouge">\((\vec{d},\vec{y})\)</code> calculate term weights <code class="highlighter-rouge">\(w_{ci}\)</code> as:
    <ol>
      <li><code class="highlighter-rouge">\(\hat\theta_{ci}=\frac{d_{ic}+\alpha_i}{\sum_k{d_{kc}}+\alpha}\)</code></li>
      <li><code class="highlighter-rouge">\(w_{ci}=\log{\hat\theta_{ci}}\)</code></li>
    </ol>
  </li>
  <li><strong>Training: CBayes</strong><code class="highlighter-rouge">\((\vec{d},\vec{y})\)</code> calculate term weights <code class="highlighter-rouge">\(w_{ci}\)</code> as:
    <ol>
      <li><code class="highlighter-rouge">\(\hat\theta_{ci} = \frac{\sum_{j:y_j\neq c}d_{ij}+\alpha_i}{\sum_{j:y_j\neq c}{\sum_k{d_{kj}}}+\alpha}\)</code></li>
      <li><code class="highlighter-rouge">\(w_{ci}=-\log{\hat\theta_{ci}}\)</code></li>
      <li><code class="highlighter-rouge">\(w_{ci}=\frac{w_{ci}}{\sum_i \lvert w_{ci}\rvert}\)</code></li>
    </ol>
  </li>
  <li><strong>Label Assignment/Testing:</strong>
    <ol>
      <li>Let <code class="highlighter-rouge">\(\vec{t}= (t_1,...,t_n)\)</code> be a test document; let <code class="highlighter-rouge">\(t_i\)</code> be the count of the word <code class="highlighter-rouge">\(t\)</code>.</li>
      <li>Label the document according to <code class="highlighter-rouge">\(l(t)=\arg\max_c \sum\limits_{i} t_i w_{ci}\)</code></li>
    </ol>
  </li>
</ul>

<p>As we can see, the main difference between Bayes and CBayes is the weight calculation step.  Where Bayes weighs terms more heavily based on the likelihood that they belong to class <code class="highlighter-rouge">\(c\)</code>, CBayes seeks to maximize term weights on the likelihood that they do not belong to any other class.</p>

<h2 id="running-from-the-command-line">Running from the command line</h2>

<p>Mahout provides CLI drivers for all above steps.  Here we will give a simple overview of Mahout CLI commands used to preprocess the data, train the model and assign labels to the training set. An <a href="https://github.com/apache/mahout/blob/master/examples/bin/classify-20newsgroups.sh">example script</a> is given for the full process from data acquisition through classification of the classic <a href="https://mahout.apache.org/users/classification/twenty-newsgroups.html">20 Newsgroups corpus</a>.</p>

<ul>
  <li>
    <p><strong>Preprocessing:</strong>
For a set of Sequence File Formatted documents in PATH_TO_SEQUENCE_FILES the <a href="https://mahout.apache.org/users/basics/creating-vectors-from-text.html">mahout seq2sparse</a> command performs the TF-IDF transformations (-wt tfidf option) and L2 length normalization (-n 2 option) as follows:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ mahout seq2sparse 
    -i ${PATH_TO_SEQUENCE_FILES} 
    -o ${PATH_TO_TFIDF_VECTORS} 
    -nv 
    -n 2
    -wt tfidf
</code></pre>
    </div>
  </li>
  <li>
    <p><strong>Training:</strong>
The model is then trained using <code class="highlighter-rouge">mahout spark-trainnb</code>.  The default is to train a Bayes model. The -c option is given to train a CBayes model:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ mahout spark-trainnb
    -i ${PATH_TO_TFIDF_VECTORS} 
    -o ${PATH_TO_MODEL}
    -ow 
    -c
</code></pre>
    </div>
  </li>
  <li>
    <p><strong>Label Assignment/Testing:</strong>
Classification and testing on a holdout set can then be performed via <code class="highlighter-rouge">mahout spark-testnb</code>. Again, the -c option indicates that the model is CBayes:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ mahout spark-testnb 
    -i ${PATH_TO_TFIDF_TEST_VECTORS}
    -m ${PATH_TO_MODEL} 
    -c 
</code></pre>
    </div>
  </li>
</ul>

<h2 id="command-line-options">Command line options</h2>

<ul>
  <li>
    <p><strong>Preprocessing:</strong> <em>note: still reliant on MapReduce seq2sparse</em></p>

    <p>Only relevant parameters used for Bayes/CBayes as detailed above are shown. Several other transformations can be performed by <code class="highlighter-rouge">mahout seq2sparse</code> and used as input to Bayes/CBayes.  For a full list of <code class="highlighter-rouge">mahout seq2Sparse</code> options see the <a href="https://mahout.apache.org/users/basics/creating-vectors-from-text.html">Creating vectors from text</a> page.</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ mahout seq2sparse                         
    --output (-o) output             The directory pathname for output.        
    --input (-i) input               Path to job input directory.              
    --weight (-wt) weight            The kind of weight to use. Currently TF   
                                         or TFIDF. Default: TFIDF                  
    --norm (-n) norm                 The norm to use, expressed as either a    
                                         float or "INF" if you want to use the     
                                         Infinite norm.  Must be greater or equal  
                                         to 0.  The default is not to normalize    
    --overwrite (-ow)                If set, overwrite the output directory    
    --sequentialAccessVector (-seq)  (Optional) Whether output vectors should  
                                         be SequentialAccessVectors. If set true   
                                         else false                                
    --namedVector (-nv)              (Optional) Whether output vectors should  
                                         be NamedVectors. If set true else false   
</code></pre>
    </div>
  </li>
  <li>
    <p><strong>Training:</strong></p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ mahout spark-trainnb
    --input (-i) input               Path to job input directory.                 
    --output (-o) output             The directory pathname for output.           
    --trainComplementary (-c)        Train complementary? Default is false.
    --master (-ma)                   Spark Master URL (optional). Default: "local".
                                         Note that you can specify the number of 
                                         cores to get a performance improvement, 
                                         for example "local[4]"
    --help (-h)                      Print out help                               
</code></pre>
    </div>
  </li>
  <li>
    <p><strong>Testing:</strong></p>

    <div class="highlighter-rouge"><pre class="highlight"><code>  $ mahout spark-testnb   
    --input (-i) input               Path to job input directory.                  
    --model (-m) model               The path to the model built during training.   
    --testComplementary (-c)         Test complementary? Default is false.                          
    --master (-ma)                   Spark Master URL (optional). Default: "local". 
                                         Note that you can specify the number of 
                                         cores to get a performance improvement, 
                                         for example "local[4]"                        
    --help (-h)                      Print out help                                
</code></pre>
    </div>
  </li>
</ul>

<h2 id="examples">Examples</h2>
<ol>
  <li><a href="https://github.com/apache/mahout/blob/master/examples/bin/classify-20newsgroups.sh">20 Newsgroups classification</a></li>
  <li><a href="https://github.com/apache/mahout/blob/master/examples/bin/spark-document-classifier.mscala">Document classification with Naive Bayes in the Mahout shell</a></li>
</ol>

<h2 id="references">References</h2>



  <footer class="footer bg-light">
    <div class="container text-center small">
        Copyright &copy; 2014-2018 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.
    </div>
</footer>

  <script src="/assets/vendor/jquery/jquery-slim.min.js"></script>
  <script src="/assets/vendor/popper/popper.min.js"></script>
  <script src="/assets/vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="/assets/header.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

</body>

</html>
